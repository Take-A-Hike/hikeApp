<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div class="postal-code">
        <input type="text" placeholder="postal code">
        <input type="submit" value="search">
    </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
<script>
    
    const routeKey = `Aia7N7IYQAD2wuOi_t3bwY9x9AqsymMip5UUZSY_OhyJF9uYSkjb3UkwFhIVP7nJ`
    const geoKey = `51b65eec5dc1479abcc1262f017405a2`

    const postalCode = $("input").val();

    const totalTime = function (seconds){
        const hours = Math.floor(seconds/3600);
        const minutes = Math.round((seconds %= 3600)/60);
        console.log(`${hours} h ${minutes} min`)
    };

    const getCoordinates = function(postalCode) {

        $.ajax({
            url:`https://api.opencagedata.com/geocode/v1/json`,
            method: "GET",
            dataTypes: 'json',
            data:{
                q: postalCode,
                key: geoKey
            }
        }).then(function(data){
            const dLat = data.results[0].geometry.lat;
            const dLong = data.results[0].geometry.lng;
            console.log(dLat, dLong);
            getRoute(dLat,dLong,40.7572805,-73.985855);

        }).fail(function(error){
            console.log(error);
        });
    };

    const getRoute = function(dLat, dLong, aLat, aLong) {

    const depart = dLat + ",%20" + dLong
    const arrive = aLat + ",%20" + aLong
    
    console.log("we are calling api");
    $.ajax({
        url:`http://dev.virtualearth.net/REST/V1/Routes/Driving?wp.0=${depart}&wp.1=${arrive}`,
        method: "GET",
        dataTypes: 'json',
        data:{
            avoid: "minimizeTolls",
            key: routeKey
        }
    }).then(function(result){
        const driveDistance = result.resourceSets[0].resources[0].travelDistance;
        const driveTimeSeconds = result.resourceSets[0].resources[0].travelDuration;
        const driveTrafficSeconds = result.resourceSets[0].resources[0].travelDurationTraffic;

        console.log("distance", driveDistance + " km");
        console.log("time", totalTime(driveTimeSeconds));
        console.log("time with traffic", totalTime(driveTrafficSeconds));
    }).fail(function(error){
        console.log(error);
    });
};

$(function(){
    $("input[type='submit']").on("click", function(){
        console.log(postalCode);
        getCoordinates(postalCode);
    })
})

</script>
</html>